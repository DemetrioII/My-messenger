// message.hpp
#pragma once
#include <any>
#include <chrono>
#include <memory>
#include <optional>
#include <stdint.h>
#include <string>
#include <vector>

enum class MessageType {
  Text = 0x00,
  Command = 0x01,
  HandShake = 0x02,
  CipherMessage = 0x03,
  Response = 0x04,
  FileStart = 0x05,
  FileChunk = 0x06,
  FileEnd = 0x07
};

enum class CommandType {
  SEND = 0x01,
  LOGIN = 0x02,
  MAKE_ROOM = 0x03,
  JOIN = 0x04,
  GET_PUBKEY = 0x05,
  GET_USERNAME = 0x06,
  GET_ID = 0x07,
  PRIVATE_MESSAGE = 0x08,
  SEND_FILE = 0x09,
  HELP = 0x10,
  EXIT = 0xFE,
  UNKNOWN = 0xFF,
};

struct MessageHeader {
  MessageType type;
  uint32_t length;
  uint32_t checksum;
  uint64_t timestamp;

  std::vector<uint8_t> serialize() const;
  static MessageHeader deserialize(const std::vector<uint8_t> &data);

  // bool validate() const;
};

class Message {
  friend class Serializer;
  friend class Parser;

private:
  MessageHeader header;
  uint8_t metalen;
  std::vector<std::vector<uint8_t>> metadata;
  std::vector<uint8_t> payload;

public:
  Message() = default;
  Message(const std::vector<uint8_t> &payload_, uint8_t metalen_,
          const std::vector<std::vector<uint8_t>> &metadata_,
          MessageType type = MessageType::Text);

  Message(std::vector<uint8_t> &&payload_, uint8_t metalen_,
          std::vector<std::vector<uint8_t>> &&metadata_,
          MessageType type = MessageType::Text);

  MessageType get_type() const;

  void set_payload(const std::vector<uint8_t> &new_payload);

  const std::vector<uint8_t> &get_payload() const;

  const std::vector<uint8_t> &get_meta(size_t index) const;

  void insert_metadata(const std::vector<uint8_t> &meta);
  // std::vector<uint8_t> serialize() const;
  // static Message deserialize(const std::vector<uint8_t>& data);

  bool validate() const;
  void update_checksum();
};

class Serializer {
public:
  Serializer() = default;

  std::vector<uint8_t> serialize(const Message &msg) const;
  Message deserialize(const std::vector<uint8_t> &raw) const;
  ~Serializer() = default;
};

struct ClientContext;

struct ServerContext;

class IMessageHandler {
public:
  virtual ~IMessageHandler() = default;

  virtual void
  handleMessageOnClient(const Message &msg,
                        const std::shared_ptr<ClientContext> context) = 0;

  virtual void
  handleMessageOnServer(const Message &msg,
                        std::shared_ptr<ServerContext> context) = 0;

  virtual MessageType getMessageType() const = 0;
};

namespace StaticResponses {
inline const std::vector<uint8_t> CHAT_NOT_FOUND = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x43, 0x68, 0x61, 0x74,
    0x20, 0x6e, 0x6f, 0x74, 0x20, 0x66, 0x6f, 0x75, 0x6e, 0x64,
};

inline const std::vector<uint8_t> USER_NOT_FOUND = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x16, 0x5b, 0x45, 0x52, 0x52,
    0x4f, 0x52, 0x5d, 0x20, 0x55, 0x73, 0x65, 0x72, 0x20, 0x6e,
    0x6f, 0x74, 0x20, 0x66, 0x6f, 0x75, 0x6e, 0x64,
};

inline const std::vector<uint8_t> YOU_NEED_TO_LOGIN = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x5b, 0x45, 0x72, 0x72, 0x6f,
    0x72, 0x5d, 0x3a, 0x20, 0x59, 0x6f, 0x75, 0x20, 0x6d, 0x75, 0x73,
    0x74, 0x20, 0x61, 0x75, 0x74, 0x68, 0x65, 0x6e, 0x74, 0x69, 0x63,
    0x61, 0x74, 0x65, 0x20, 0x66, 0x69, 0x72, 0x73, 0x74,
};

inline const std::vector<uint8_t> WRONG_COMMAND_USAGE = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x5b, 0x45, 0x72, 0x72, 0x6f,
    0x72, 0x5d, 0x3a, 0x20, 0x57, 0x72, 0x6f, 0x6e, 0x67, 0x20, 0x63,
    0x6f, 0x6d, 0x6d, 0x61, 0x6e, 0x64, 0x20, 0x75, 0x73, 0x61, 0x67,
    0x65, 0x2e, 0x20, 0x50, 0x6c, 0x65, 0x61, 0x73, 0x65, 0x20, 0x75,
    0x73, 0x65, 0x20, 0x2f, 0x68, 0x65, 0x6c, 0x70, 0x20, 0x74, 0x6f,
    0x20, 0x67, 0x65, 0x74, 0x20, 0x61, 0x20, 0x68, 0x65, 0x6c, 0x70,
};

inline const std::vector<uint8_t> EMPTY_CHAT_NAME = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x5b, 0x45, 0x72, 0x72,
    0x6f, 0x72, 0x5d, 0x3a, 0x20, 0x45, 0x6d, 0x70, 0x74, 0x79,
    0x20, 0x63, 0x68, 0x61, 0x74, 0x20, 0x6e, 0x61, 0x6d, 0x65,
};

inline const std::vector<uint8_t> CHAT_ALREADY_EXISTS = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x5b, 0x45, 0x72, 0x72,
    0x6f, 0x72, 0x5d, 0x3a, 0x20, 0x43, 0x68, 0x61, 0x74, 0x20,
    0x69, 0x73, 0x20, 0x61, 0x6c, 0x72, 0x65, 0x61, 0x64, 0x79,
    0x20, 0x65, 0x78, 0x69, 0x73, 0x74, 0x73,
};

inline const std::vector<uint8_t> YOU_ARE_ALREADY_MEMBER = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x2c, 0x5b, 0x45, 0x72, 0x72,
    0x6f, 0x72, 0x5d, 0x3a, 0x20, 0x59, 0x6f, 0x75, 0x20, 0x61,
    0x72, 0x65, 0x20, 0x61, 0x6c, 0x72, 0x65, 0x61, 0x64, 0x79,
    0x20, 0x6d, 0x65, 0x6d, 0x62, 0x65, 0x72, 0x20, 0x6f, 0x66,
    0x20, 0x74, 0x68, 0x69, 0x73, 0x20, 0x63, 0x68, 0x61, 0x74,
};

inline const std::vector<uint8_t> PUBLIC_KEY_HAS_NOT_SET = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x5b, 0x45, 0x72, 0x72, 0x6f,
    0x72, 0x5d, 0x3a, 0x20, 0x50, 0x75, 0x62, 0x6c, 0x69, 0x63, 0x20,
    0x6b, 0x65, 0x79, 0x20, 0x68, 0x61, 0x73, 0x20, 0x6e, 0x6f, 0x74,
    0x20, 0x62, 0x65, 0x65, 0x6e, 0x20, 0x73, 0x65, 0x74,
};
}; // namespace StaticResponses
